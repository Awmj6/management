<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>会员名单</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>会员名单</h2>

    <div id="members-table"></div>
    <button onclick="saveData()">保存</button>
    <button onclick="exportToExcel('members')">导出为 Excel</button>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const container = document.getElementById('members-table');

        const membersData = {{ members_data | tojson }};
        const formattedData = membersData.map(member => [
          member.name,
          member.contact,
          member.recharge_amount,
          member.balance
        ]);

        const hot = new Handsontable(container, {
          data: formattedData,
          colHeaders: ["会员名字", "电话号码", "充值金额", "存储金额"],
          rowHeaders: true,
          contextMenu: true,
          manualColumnResize: true,
          manualRowResize: true,
          minSpareRows: 1,
          columns: [
            {},
            {},
            { type: 'numeric' },
            { type: 'numeric' }
          ],
          licenseKey: 'non-commercial-and-evaluation'
        });

        function saveData() {
          const data = hot.getData().filter(row => row.some(cell => cell !== null && cell !== ""));
          $.ajax({
            url: '/save_members',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
              alert("表格保存成功!");
            },
            error: function(error) {
              console.error("保存失败:", error);
            }
          });
        }

        window.saveData = saveData;

      });

      function exportToExcel(sheetName) {
        const data = hot.getData();
        const ws = XLSX.utils.aoa_to_sheet([["会员名字", "电话号码", "充值金额", "存储金额"], ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `${sheetName}.xlsx`);
      }
    </script>
</body>
</html>
